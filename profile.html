<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang cá nhân - Sơn La Agri</title>
    <link rel="stylesheet" href="DoAn.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .profile-container { display: grid; grid-template-columns: 250px 1fr; gap: 20px; max-width: 1200px; margin: 30px auto; }
        .profile-sidebar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: fit-content; }
        .profile-content { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sidebar-menu button { width: 100%; text-align: left; padding: 12px; border: none; background: none; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .sidebar-menu button.active { color: #2c5f2d; font-weight: bold; background: #f0f7f0; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        .btn-buy { background: #2c5f2d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-buy:hover { background: #4CAF50; }
        
        /* Stepper CSS */
        .tracking-stepper { display: flex; justify-content: space-between; margin: 30px 0; position: relative; }
        .tracking-stepper::before { content: ""; position: absolute; top: 15px; left: 0; width: 100%; height: 2px; background: #ddd; z-index: 1; }
        .step-v2 { position: relative; z-index: 2; text-align: center; flex: 1; }
        .step-v2 span { width: 30px; height: 30px; line-height: 30px; border-radius: 50%; background: #ddd; display: inline-block; color: white; font-weight: bold; }
        .step-v2 p { font-size: 11px; margin-top: 5px; color: #888; }
        .step-v2.active span { background: #2c5f2d; box-shadow: 0 0 8px rgba(44,95,45,0.4); }
        .step-v2.active p { color: #2c5f2d; font-weight: bold; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background: #eee; }
        
        /* Rating CSS */
        .star-rating { display: flex; gap: 5px; cursor: pointer; font-size: 20px; color: #ccc; }
        .star-rating i.active { color: #ff9800; }
        .review-box { margin-top: 10px; display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        
        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container"><a href="DoAn.html" class="logo">SƠN LA <span>AGRI</span></a></div>
    </header>

    <div class="profile-container container">
        <div class="profile-sidebar">
            <div class="sidebar-menu">
                <button onclick="showTab('info')" id="btn-info" class="active"><i class="fa fa-user"></i> Thông tin cá nhân</button>
                <button onclick="showTab('orders')" id="btn-orders"><i class="fa fa-shopping-bag"></i> Lịch sử đơn hàng</button>
                <button onclick="showTab('tracking')" id="btn-tracking"><i class="fa fa-truck"></i> Theo dõi đơn hàng</button>
                <button onclick="showTab('password')" id="btn-password"><i class="fa fa-lock"></i> Đổi mật khẩu</button>
                <button onclick="handleLogout()" style="color: red;"><i class="fa fa-sign-out"></i> Đăng xuất</button>
            </div>
        </div>

        <div class="profile-content">
            <div id="tab-info" class="tab-item">
                <h3>Thông tin cá nhân</h3>
                <hr style="margin: 15px 0;">
                <div class="form-group"><label>Họ tên</label><input type="text" id="p-name"></div>
                <div class="form-group"><label>Email (Không thể sửa)</label><input type="text" id="p-email" disabled></div>
                <div class="form-group"><label>Số điện thoại</label><input type="text" id="p-phone"></div>
                <button class="btn-buy" onclick="updateProfile()">LƯU THAY ĐỔI</button>
            </div>

            <div id="tab-orders" class="tab-item" style="display:none;">
                <h3><i class="fa fa-history"></i> LỊCH SỬ ĐƠN HÀNG</h3>
                <hr style="margin: 15px 0;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #2c5f2d;">
                            <th style="padding: 10px; text-align: left;">Mã đơn</th>
                            <th style="padding: 10px; text-align: left;">Ngày đặt</th>
                            <th style="padding: 10px; text-align: left;">Tổng tiền</th>
                            <th style="padding: 10px; text-align: left;">Trạng thái</th>
                            <th style="padding: 10px; text-align: center;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="my-orders-list"></tbody>
                </table>
            </div>

            <div id="tab-tracking" class="tab-item" style="display:none;">
                <h3><i class="fa fa-truck"></i> TIẾN ĐỘ ĐƠN HÀNG CỦA BẠN</h3>
                <hr style="margin: 15px 0;">
                <div id="tracking-list-container"></div>
            </div>

            <div id="tab-password" class="tab-item" style="display:none;">
                <h3>Đổi mật khẩu</h3>
                <hr style="margin: 15px 0;">
                <div class="form-group"><label>Mật khẩu cũ</label><input type="password" id="old-pass"></div>
                <div class="form-group"><label>Mật khẩu mới</label><input type="password" id="new-pass"></div>
                <div class="form-group"><label>Xác nhận mật khẩu mới</label><input type="password" id="confirm-pass"></div>
                <button class="btn-buy" onclick="changePassword()">CẬP NHẬT MẬT KHẨU</button>
            </div>
        </div>
    </div>

    <div id="orderDetailModal" class="modal-overlay">
        <div style="background:white; width:90%; max-width:750px; border-radius:10px; padding:25px; max-height:90vh; overflow-y:auto; position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3>Chi tiết đơn hàng <span id="det-id" style="color:#2c5f2d"></span></h3>
                <button onclick="closeOrderDetail()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div class="tracking-stepper">
                <div id="st-1" class="step-v2"><span>1</span><p>Chờ xác nhận</p></div>
                <div id="st-2" class="step-v2"><span>2</span><p>Chuẩn bị hàng</p></div>
                <div id="st-3" class="step-v2"><span>3</span><p>Đang giao</p></div>
                <div id="st-4" class="step-v2"><span>4</span><p>Đã giao</p></div>
            </div>
            <div id="det-products" style="margin:20px 0;"></div>
            <div style="border-top:1px solid #eee; padding-top:15px; text-align:right;">
                <p>Thanh toán: <span id="det-pay" style="font-weight:bold; color:green;"></span></p> 
                <p style="font-size:18px;">Tổng thanh toán: <strong id="det-total" style="color:#d32f2f"></strong></p>
            </div>
        </div>
    </div>

    <script>
    // 1. KIỂM TRA ĐĂNG NHẬP
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user) { 
        window.location.href = 'DoAn.html'; 
    } else {
        document.getElementById('p-name').value = user.HoTen || "";
        document.getElementById('p-email').value = user.Email || "";
        document.getElementById('p-phone').value = user.SoDienThoai || "";
    }

    // 2. QUẢN LÝ CHUYỂN ĐỔI TAB
    function showTab(tabName) {
        document.querySelectorAll('.tab-item').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.sidebar-menu button').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).style.display = 'block';
        document.getElementById('btn-' + tabName).classList.add('active');
        
        if(tabName === 'orders') loadOrders();
        if(tabName === 'tracking') loadTrackingList();
    }

    // 3. TẢI LỊCH SỬ ĐƠN HÀNG (Dành cho trạng thái đã kết thúc)
    async function loadOrders() {
        try {
            const res = await fetch(`https://nongsansonla.loca.lt/api/my-orders/${user.SoDienThoai}`);
            const data = await res.json();
            const list = document.getElementById('my-orders-list');
            
            const finishedOrders = data.filter(o => 
                ["Hoàn thành", "Đã giao", "Hủy", "Giao hàng thành công"].includes(o.TrangThaiDonHang)
            );

            if (finishedOrders.length === 0) {
                list.innerHTML = "<tr><td colspan='5' style='padding:20px; text-align:center;'>Không có lịch sử đơn hàng.</td></tr>";
                return;
            }

            list.innerHTML = finishedOrders.map(o => `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:12px;">#${o.MaDonHang}</td>
                    <td>${new Date(o.NgayDat).toLocaleDateString('vi-VN')}</td>
                    <td style="font-weight:bold;">${Number(o.TongTien).toLocaleString()}đ</td>
                    <td><span class="status-badge" style="color:${o.TrangThaiDonHang==='Hủy'?'red':'green'}">${o.TrangThaiDonHang}</span></td>
                    <td style="text-align:center;">
                        <button onclick="viewOrderDetail(${o.MaDonHang})" style="color:#2c5f2d; background:none; border:none; cursor:pointer; font-weight:bold;">XEM CHI TIẾT</button>
                    </td>
                </tr>`).join('');
        } catch (err) { console.error("Lỗi tải lịch sử:", err); }
    }

    // 4. THEO DÕI TIẾN ĐỘ ĐƠN HÀNG ĐANG XỬ LÝ
    async function loadTrackingList() {
        const container = document.getElementById('tracking-list-container');
        container.innerHTML = "<p>Đang kiểm tra tiến độ...</p>";
        try {
            const res = await fetch(`https://nongsansonla.loca.lt/api/my-orders/${user.SoDienThoai}`);
            const data = await res.json();
            
            const pendingOrders = data.filter(o => 
                !["Hoàn thành", "Đã giao", "Hủy", "Giao hàng thành công"].includes(o.TrangThaiDonHang)
            );

            if (pendingOrders.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:30px; color:#666;'><i class='fa fa-box-open' style='font-size:40px;'></i><p>Bạn không có đơn hàng nào đang xử lý.</p></div>";
                return;
            }

            container.innerHTML = pendingOrders.map(o => `
                <div class="order-item" style="margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>Mã đơn: #${o.MaDonHang}</strong>
                        <span class="status-badge" style="background:#fff3cd; color:#856404;">${o.TrangThaiDonHang}</span>
                    </div>
                    <div class="tracking-stepper">
                        <div class="step-v2 ${getActiveClass(o.TrangThaiDonHang, 1)}"><span>1</span><p>Chờ xác nhận</p></div>
                        <div class="step-v2 ${getActiveClass(o.TrangThaiDonHang, 2)}"><span>2</span><p>Chuẩn bị</p></div>
                        <div class="step-v2 ${getActiveClass(o.TrangThaiDonHang, 3)}"><span>3</span><p>Đang giao</p></div>
                        <div class="step-v2 ${getActiveClass(o.TrangThaiDonHang, 4)}"><span>4</span><p>Đã giao</p></div>
                    </div>
                    <p>Thanh toán: <b style="color:green">${o.TrangThaiThanhToan}</b></p>
                    <button onclick="viewOrderDetail(${o.MaDonHang})" class="btn-buy" style="width:auto; margin-top:10px;">XEM CHI TIẾT SẢN PHẨM</button>
                </div>`).join('');
        } catch (err) { container.innerHTML = "Lỗi kết nối máy chủ!"; }
    }

    function getActiveClass(status, stepIndex) {
        const map = { "Chờ xác nhận": 1, "Đã xác nhận": 2, "Đang chuẩn bị hàng": 2, "Đang giao": 3, "Giao hàng thành công": 4, "Hoàn thành": 4, "Đã giao": 4 };
        return stepIndex <= (map[status] || 1) ? "active" : "";
    }

    // 5. XEM CHI TIẾT ĐƠN HÀNG VÀ LOGIC ĐÁNH GIÁ (FIX LỖI KẾT NỐI)
    async function viewOrderDetail(id) {
        try {
            const res = await fetch(`https://nongsansonla.loca.lt/api/order-detail/${id}`);
            if (!res.ok) throw new Error("Server error");
            
            const data = await res.json();
            const order = data.order;
            const products = data.products;
            
            document.getElementById('orderDetailModal').style.display = 'flex';
            document.getElementById('det-id').innerText = "#" + id;
            document.getElementById('det-pay').innerText = order.TrangThaiThanhToan || "N/A";
            document.getElementById('det-total').innerText = Number(order.TongTien || 0).toLocaleString() + "đ";

            const isDelivered = ["Hoàn thành", "Đã giao", "Giao hàng thành công"].includes(order.TrangThaiDonHang);
            
            document.getElementById('det-products').innerHTML = products.map(p => {
                const isDelivered = ["Hoàn thành", "Đã giao", "Giao hàng thành công"].includes(order.TrangThaiDonHang);
                let reviewHTML = "";

                if (isDelivered) {
                    if (p.DaDanhGia > 0) {
                        reviewHTML = `<span style="color: #2c5f2d; font-weight: bold; font-size: 13px;">
                                        <i class="fa fa-check-circle"></i> Đã đánh giá
                                    </span>`;
                    } else {
                        reviewHTML = `<button onclick="toggleReviewBox(${p.MaSanPham})" 
                                        style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:11px;">
                                        ĐÁNH GIÁ NGAY
                                    </button>`;
                    }
                }

                return `
                <div style="border-bottom: 1px solid #eee; padding: 12px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <img src="${p.LinkAnh}" width="60" height="60" style="object-fit:cover; border-radius:5px;">
                            <div>
                                <b>${p.TenSanPham}</b><br><small>Số lượng: ${p.SoLuong}</small>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color:#d32f2f; font-weight:bold;">${Number(p.GiaBan).toLocaleString()}đ</div>
                            ${reviewHTML}
                        </div>
                    </div>
                    
                    <div id="review-box-${p.MaSanPham}" class="review-box" style="display:none; margin-top:10px; background:#f9f9f9; padding:15px; border-radius:8px;">
                        <div class="star-rating" id="stars-${p.MaSanPham}">
                            ${[1,2,3,4,5].map(i => `<i class="fa fa-star" onclick="setStar(${p.MaSanPham}, ${i})" style="cursor:pointer; font-size:20px;"></i>`).join('')}
                        </div>
                        <textarea id="text-${p.MaSanPham}" placeholder="Hãy chia sẻ nhận xét của bạn về sản phẩm này..." 
                                style="width:100%; height:80px; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:5px;"></textarea>
                        <button onclick="sendReview(${order.MaDonHang}, ${p.MaSanPham})" 
                                class="btn-buy" style="width:auto; padding:8px 25px;">GỬI ĐÁNH GIÁ</button>
                    </div>
                </div>`;
            }).join('');
            
            updateStepper(order.TrangThaiDonHang);
        } catch (err) { 
            console.error(err);
            alert("Lỗi kết nối máy chủ! Hãy chắc chắn Server Node.js đang chạy ở cổng 5000."); 
        }
    }

    // 6. XỬ LÝ GỬI ĐÁNH GIÁ
    let selectedStars = {};
    function toggleReviewBox(maSP) {
        const box = document.getElementById(`review-box-${maSP}`);
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
    }
    function setStar(maSP, stars) {
        selectedStars[maSP] = stars;
        const icons = document.getElementById(`stars-${maSP}`).querySelectorAll('i');
        icons.forEach((icon, i) => icon.classList.toggle('active', i < stars));
    }

    async function sendReview(maDH, maSP) {
        const stars = selectedStars[maSP] || 0;
        const content = document.getElementById(`text-${maSP}`).value;
        if (stars === 0) return alert("Vui lòng chọn số sao!");

        try {
            const res = await fetch('https://nongsansonla.loca.lt/api/danhgia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ maDH, maSP, maND: user.MaNguoiDung, soSao: stars, noiDung: content })
            });
            const data = await res.json();
            if (data.success) {
                alert("⭐ Cảm ơn bạn đã đánh giá!");
                viewOrderDetail(maDH); // Gọi lại để cập nhật trạng thái "Đã đánh giá xong"
            }
        } catch (err) { alert("Lỗi gửi đánh giá!"); }
    }

    // 7. CẬP NHẬT THANH TIẾN ĐỘ
    function updateStepper(status) {
        document.querySelectorAll('.step-v2').forEach(s => s.classList.remove('active'));
        const st1 = document.getElementById('st-1');
        if (st1) st1.classList.add('active');

        if (["Đã xác nhận", "Đang chuẩn bị hàng"].includes(status)) {
            document.getElementById('st-2').classList.add('active');
        } else if (status === "Đang giao") {
            document.getElementById('st-2').classList.add('active');
            document.getElementById('st-3').classList.add('active');
        } else if (["Hoàn thành", "Đã giao", "Giao hàng thành công"].includes(status)) {
            document.getElementById('st-2').classList.add('active');
            document.getElementById('st-3').classList.add('active');
            document.getElementById('st-4').classList.add('active');
        }
    }

    function closeOrderDetail() { document.getElementById('orderDetailModal').style.display = 'none'; }

    // 8. TIỆN ÍCH
    async function updateProfile() {
        const hoTen = document.getElementById('p-name').value;
        const sdt = document.getElementById('p-phone').value;
        try {
            const res = await fetch('https://nongsansonla.loca.lt/api/user/update', {
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: user.MaNguoiDung, hoTen, sdt })
            });
            if((await res.json()).success) { 
                alert("✅ Đã cập nhật thành công!"); 
                user.HoTen = hoTen; user.SoDienThoai = sdt;
                localStorage.setItem('user', JSON.stringify(user));
            }
        } catch (err) { alert("Lỗi cập nhật!"); }
    }

    async function changePassword() {
        const mkCu = document.getElementById('old-pass').value;
        const mkMoi = document.getElementById('new-pass').value;
        if(mkMoi !== document.getElementById('confirm-pass').value) return alert("Mật khẩu nhập lại không khớp!");
        try {
            const res = await fetch('https://nongsansonla.loca.lt/api/user/change-password', {
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: user.MaNguoiDung, mkCu, mkMoi })
            });
            const data = await res.json();
            alert(data.success ? "✅ " + data.message : "❌ " + data.message);
        } catch (err) { alert("Lỗi hệ thống!"); }
    }

    function handleLogout() { 
        if(confirm("Bạn có chắc muốn đăng xuất?")) { 
            localStorage.removeItem('user'); 
            window.location.href = 'DoAn.html'; 
        } 
    }
</script>
</body>
</html>
